<!DOCTYPE html>
<html lang="zh-cn">
    <head> 
        <meta charset="UTF-8">
    </head>
  <body>
<div>
    <h2>
        <i class="">交易数据探查（欺诈环）</i>
    </h2>
    
    <div>
        <img src="graph-17.svg"/>
        <img src="graph-18.svg"/>
        <img src="graph-16.svg"/>
        <img src="graph-15.svg"/>
    </div>
    <div>
        <code><pre>
            ## 反洗钱 反洗钱的一个模型

```shell
MATCH (n)

WHERE n:客户 OR n:交易 OR n:银行 OR n:受益人

DETACH DELETE n
```

### 创建客户节点
```cypher
CREATE (:客户 {ID: 1, 姓名: '张伟', 地址: '北京市朝阳区', 国籍: '中国'})
CREATE (:客户 {ID: 2, 姓名: '李娜', 地址: '上海市浦东新区', 国籍: '中国'})
CREATE (:客户 {ID: 3, 姓名: '王强', 地址: '广州市天河区', 国籍: '中国'})
CREATE (:客户 {ID: 4, 姓名: '赵敏', 地址: '深圳市南山区', 国籍: '中国'})
CREATE (:客户 {ID: 5, 姓名: '刘洋', 地址: '杭州市西湖区', 国籍: '中国'})
CREATE (:客户 {ID: 6, 姓名: '陈静', 地址: '成都市武侯区', 国籍: '中国'})
CREATE (:客户 {ID: 7, 姓名: '周杰', 地址: '武汉市江岸区', 国籍: '中国'})
CREATE (:客户 {ID: 8, 姓名: '吴明', 地址: '南京市玄武区', 国籍: '中国'})
CREATE (:客户 {ID: 9, 姓名: '郑华', 地址: '重庆市渝中区', 国籍: '中国'})
CREATE (:客户 {ID: 10, 姓名: '韩梅', 地址: '西安市雁塔区', 国籍: '中国'})
```

### 创建受益人节点(受益人其实也是客户，不应该重复创建的，v2版本将其删除掉)
```cypher
CREATE (:受益人 {ID: 1, 姓名: '张伟', 地址: '北京市朝阳区', 国籍: '中国'})
CREATE (:受益人 {ID: 2, 姓名: '李娜', 地址: '上海市浦东新区', 国籍: '中国'})
CREATE (:受益人 {ID: 3, 姓名: '王强', 地址: '广州市天河区', 国籍: '中国'})
CREATE (:受益人 {ID: 4, 姓名: '赵敏', 地址: '深圳市南山区', 国籍: '中国'})
CREATE (:受益人 {ID: 5, 姓名: '刘洋', 地址: '杭州市西湖区', 国籍: '中国'})
CREATE (:受益人 {ID: 6, 姓名: '陈静', 地址: '成都市武侯区', 国籍: '中国'})
CREATE (:受益人 {ID: 7, 姓名: '周杰', 地址: '武汉市江岸区', 国籍: '中国'})
CREATE (:受益人 {ID: 8, 姓名: '吴明', 地址: '南京市玄武区', 国籍: '中国'})
CREATE (:受益人 {ID: 9, 姓名: '郑华', 地址: '重庆市渝中区', 国籍: '中国'})
CREATE (:受益人 {ID: 10, 姓名: '韩梅', 地址: '西安市雁塔区', 国籍: '中国'})
```

### 创建银行节点
```cypher
CREATE (:银行 {ID: 1, 名称: '中国工商银行', 地址: '北京市'})
CREATE (:银行 {ID: 2, 名称: '中国建设银行', 地址: '上海市'})
CREATE (:银行 {ID: 3, 名称: '中国银行', 地址: '广州市'})
CREATE (:银行 {ID: 4, 名称: '中国农业银行', 地址: '深圳市'})
CREATE (:银行 {ID: 5, 名称: '交通银行', 地址: '杭州市'})
CREATE (:银行 {ID: 6, 名称: '招商银行', 地址: '成都市'})
CREATE (:银行 {ID: 7, 名称: '兴业银行', 地址: '武汉市'})
CREATE (:银行 {ID: 8, 名称: '中信银行', 地址: '南京市'})
CREATE (:银行 {ID: 9, 名称: '光大银行', 地址: '重庆市'})
CREATE (:银行 {ID: 10, 名称: '浦发银行', 地址: '西安市'})
```

### 创建交易节点
```cypher
CREATE (:交易 {ID: 1, 金额: 1000, 时间戳: '2022-01-01'})
CREATE (:交易 {ID: 2, 金额: 500, 时间戳: '2022-02-01'})
CREATE (:交易 {ID: 3, 金额: 2000, 时间戳: '2022-03-01'})
CREATE (:交易 {ID: 4, 金额: 1500, 时间戳: '2022-04-01'})
CREATE (:交易 {ID: 5, 金额: 800, 时间戳: '2022-05-01'})
CREATE (:交易 {ID: 6, 金额: 1200, 时间戳: '2022-06-01'})
CREATE (:交易 {ID: 7, 金额: 3000, 时间戳: '2022-07-01'})
CREATE (:交易 {ID: 8, 金额: 600, 时间戳: '2022-08-01'})
CREATE (:交易 {ID: 9, 金额: 900, 时间戳: '2022-09-01'})
CREATE (:交易 {ID: 10, 金额: 2500, 时间戳: '2022-10-01'})
```

### 创建客户与交易节点之间的关系
```cypher
MATCH (c:客户), (t:交易)
WHERE c.ID = 1 AND t.ID = 1
CREATE (c)-[:发起交易]->(t);

// 省略其他客户与交易关系的创建，按照相同模式继续添加
```

### 创建交易与受益人节点之间的关系
```cypher
MATCH (t:交易), (b:受益人)
WHERE t.ID = 1 AND b.ID = 4
CREATE (t)-[:转账给]->(b);

// 省略其他交易与受益人关系的创建，按照相同模式继续添加
```

### 创建客户与银行节点之间的关系
```cypher
MATCH (c:客户), (bank:银行)
WHERE c.ID = 1 AND bank.ID = 2
CREATE (c)-[:持有账户]->(bank);

// 省略其他客户与银行关系的创建，按照相同模式继续添加
```

### 展示客户和交易节点之间的关系
```cypher
MATCH (c:客户)-[:发起交易]->(t:交易)
RETURN c, t
```

这些Cypher语句创建了中国的客户、受益人、银行节点，并填充了符合中国国情的中文名字和地址信息。同时，它们之间建立了相应的关系，包括客户发起交易、交易转账给受益人、客户持有银行账户等。您可以根据实际情况调整这些信息，以确保它们符合您的具体需求。

```cypher
好的，以下是完整的Cypher脚本，包括创建客户、受益人、银行节点，以及它们之间的交易关系，不省略任何步骤：

```cypher
// 创建客户节点
CREATE (:客户 {ID: 1, 姓名: '张伟', 地址: '北京市朝阳区', 国籍: '中国'})
CREATE (:客户 {ID: 2, 姓名: '李娜', 地址: '上海市浦东新区', 国籍: '中国'})
CREATE (:客户 {ID: 3, 姓名: '王强', 地址: '广州市天河区', 国籍: '中国'})
CREATE (:客户 {ID: 4, 姓名: '赵敏', 地址: '深圳市南山区', 国籍: '中国'})
CREATE (:客户 {ID: 5, 姓名: '刘洋', 地址: '杭州市西湖区', 国籍: '中国'})
CREATE (:客户 {ID: 6, 姓名: '陈静', 地址: '成都市武侯区', 国籍: '中国'})
CREATE (:客户 {ID: 7, 姓名: '周杰', 地址: '武汉市江岸区', 国籍: '中国'})
CREATE (:客户 {ID: 8, 姓名: '吴明', 地址: '南京市玄武区', 国籍: '中国'})
CREATE (:客户 {ID: 9, 姓名: '郑华', 地址: '重庆市渝中区', 国籍: '中国'})
CREATE (:客户 {ID: 10, 姓名: '韩梅', 地址: '西安市雁塔区', 国籍: '中国'})

// 创建受益人节点
// CREATE (:受益人 {ID: 1, 姓名: '张伟', 地址: '北京市朝阳区', 国籍: '中国'})
// CREATE (:受益人 {ID: 2, 姓名: '李娜', 地址: '上海市浦东新区', 国籍: '中国'})
// CREATE (:受益人 {ID: 3, 姓名: '王强', 地址: '广州市天河区', 国籍: '中国'})
// CREATE (:受益人 {ID: 4, 姓名: '赵敏', 地址: '深圳市南山区', 国籍: '中国'})
// CREATE (:受益人 {ID: 5, 姓名: '刘洋', 地址: '杭州市西湖区', 国籍: '中国'})
// CREATE (:受益人 {ID: 6, 姓名: '陈静', 地址: '成都市武侯区', 国籍: '中国'})
// CREATE (:受益人 {ID: 7, 姓名: '周杰', 地址: '武汉市江岸区', 国籍: '中国'})
// CREATE (:受益人 {ID: 8, 姓名: '吴明', 地址: '南京市玄武区', 国籍: '中国'})
// CREATE (:受益人 {ID: 9, 姓名: '郑华', 地址: '重庆市渝中区', 国籍: '中国'})
// CREATE (:受益人 {ID: 10, 姓名: '韩梅', 地址: '西安市雁塔区', 国籍: '中国'})

// 创建银行节点
CREATE (:银行 {ID: 1, 名称: '中国工商银行', 地址: '北京市'})
CREATE (:银行 {ID: 2, 名称: '中国建设银行', 地址: '上海市'})
CREATE (:银行 {ID: 3, 名称: '中国银行', 地址: '广州市'})
CREATE (:银行 {ID: 4, 名称: '中国农业银行', 地址: '深圳市'})
CREATE (:银行 {ID: 5, 名称: '交通银行', 地址: '杭州市'})
CREATE (:银行 {ID: 6, 名称: '招商银行', 地址: '成都市'})
CREATE (:银行 {ID: 7, 名称: '兴业银行', 地址: '武汉市'})
CREATE (:银行 {ID: 8, 名称: '中信银行', 地址: '南京市'})
CREATE (:银行 {ID: 9, 名称: '光大银行', 地址: '重庆市'})
CREATE (:银行 {ID: 10, 名称: '浦发银行', 地址: '西安市'})

// 创建交易节点
CREATE (:交易 {ID: 1, 金额: 1000, 时间戳: '2022-01-01'})
CREATE (:交易 {ID: 2, 金额: 500, 时间戳: '2022-02-01'})
CREATE (:交易 {ID: 3, 金额: 2000, 时间戳: '2022-03-01'})
CREATE (:交易 {ID: 4, 金额: 1500, 时间戳: '2022-04-01'})
CREATE (:交易 {ID: 5, 金额: 800, 时间戳: '2022-05-01'})
CREATE (:交易 {ID: 6, 金额: 1200, 时间戳: '2022-06-01'})
CREATE (:交易 {ID: 7, 金额: 3000, 时间戳: '2022-07-01'})
CREATE (:交易 {ID: 8, 金额: 600, 时间戳: '2022-08-01'})
CREATE (:交易 {ID: 9, 金额: 900, 时间戳: '2022-09-01'})
CREATE (:交易 {ID: 10, 金额: 2500, 时间戳: '2022-10-01'});

// 创建交易节点
CREATE (:交易 {ID: 11, 金额: 2500, 时间戳: '2022-10-01'});

// 创建客户（韩梅）到交易节点的关系
MATCH (c:客户), (t:交易)
WHERE c.ID = 10 AND t.ID = 11
CREATE (c)-[:发起交易]->(t);

// 创建韩梅的交易节点到客户（郑华）节点的关系
MATCH (t:交易), (b:客户)
WHERE t.ID = 11 AND b.ID = 9
CREATE (t)-[:转账给]->(b);

// 郑华到交易节点再到刘洋的交易路径
CREATE (:交易 {ID: 12, 金额: 2500, 时间戳: '2022-10-01'});

MATCH (c:客户), (t:交易)
WHERE c.ID = 9 AND t.ID = 12
CREATE (c)-[:发起交易]->(t);

MATCH (t:交易), (b:客户)
WHERE t.ID = 12 AND b.ID = 5
CREATE (t)-[:转账给]->(b);

// 刘洋到交易节点再到李娜的交易路径
CREATE (:交易 {ID: 13, 金额: 2500, 时间戳: '2022-10-01'});

MATCH (c:客户), (t:交易)
WHERE c.ID = 5 AND t.ID = 13
CREATE (c)-[:发起交易]->(t);

MATCH (t:交易), (b:客户)
WHERE t.ID = 13 AND b.ID = 2
CREATE (t)-[:转账给]->(b);

// 李娜到张伟
CREATE (:交易 {ID: 14, 金额: 2500, 时间戳: '2022-10-01'});

MATCH (c:客户), (t:交易)
WHERE c.ID = 2 AND t.ID = 14
CREATE (c)-[:发起交易]->(t);

MATCH (t:交易), (b:客户)
WHERE t.ID = 14 AND b.ID = 1
CREATE (t)-[:转账给]->(b);

// 创建客户与交易节点之间的关系
MATCH (c:客户), (t:交易)
WHERE c.ID = 1 AND t.ID = 1
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 1 AND t.ID = 2
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 1 AND t.ID = 3
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 4 AND t.ID = 4
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 4 AND t.ID = 5
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 5 AND t.ID = 6
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 6 AND t.ID = 7
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 7 AND t.ID = 8
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 8 AND t.ID = 9
CREATE (c)-[:发起交易]->(t);
MATCH (c:客户), (t:交易)
WHERE c.ID = 8 AND t.ID = 10
CREATE (c)-[:发起交易]->(t);

// 创建交易与受益人节点之间的关系
MATCH (t:交易), (b:客户)
WHERE t.ID = 1 AND b.ID = 4
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 2 AND b.ID = 4
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 3 AND b.ID = 4
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 4 AND b.ID = 1
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 5 AND b.ID = 10
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 6 AND b.ID = 9
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 7 AND b.ID = 1
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 8 AND b.ID = 2
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 9 AND b.ID = 2
CREATE (t)-[:转账给]->(b);
MATCH (t:交易), (b:客户)
WHERE t.ID = 10 and b.ID = 2
CREATE (t)-[:转账给]->(b);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 1 and bank.ID = 2

CREATE (c)-[:持有账户]->(bank);
MATCH (c:客户), (bank:银行)

WHERE c.ID = 2 and bank.ID = 2
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 3 and bank.ID = 3

CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 4 and bank.ID = 6
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 5 and bank.ID = 10
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 6 and bank.ID = 2
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 7 and bank.ID = 3
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 8 and bank.ID = 2
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 9 and bank.ID = 2
CREATE (c)-[:持有账户]->(bank);

MATCH (c:客户), (bank:银行)
WHERE c.ID = 10 and bank.ID = 7
CREATE (c)-[:持有账户]->(bank);
```
```cypher
展示客户和交易节点之间的关系
MATCH (c:客户)-[:发起交易]->(t:交易)
RETURN c, t
```

![x](static/img/corp/graph-15.svg)

```json
[
  {
    "c": {
      "identity": 100880,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "张伟",
        "地址": "北京市朝阳区",
        "国籍": "中国",
        "ID": 1
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100880"
    },
    "t": {
      "identity": 100902,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-03-01",
        "ID": 3,
        "金额": 2000
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100902"
    }
  },
  {
    "c": {
      "identity": 100880,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "张伟",
        "地址": "北京市朝阳区",
        "国籍": "中国",
        "ID": 1
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100880"
    },
    "t": {
      "identity": 100901,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-02-01",
        "ID": 2,
        "金额": 500
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100901"
    }
  },
  {
    "c": {
      "identity": 100880,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "张伟",
        "地址": "北京市朝阳区",
        "国籍": "中国",
        "ID": 1
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100880"
    },
    "t": {
      "identity": 100900,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-01-01",
        "ID": 1,
        "金额": 1000
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100900"
    }
  },
  {
    "c": {
      "identity": 100883,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "赵敏",
        "地址": "深圳市南山区",
        "国籍": "中国",
        "ID": 4
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100883"
    },
    "t": {
      "identity": 100904,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-05-01",
        "ID": 5,
        "金额": 800
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100904"
    }
  },
  {
    "c": {
      "identity": 100883,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "赵敏",
        "地址": "深圳市南山区",
        "国籍": "中国",
        "ID": 4
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100883"
    },
    "t": {
      "identity": 100903,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-04-01",
        "ID": 4,
        "金额": 1500
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100903"
    }
  },
  {
    "c": {
      "identity": 100884,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "刘洋",
        "地址": "杭州市西湖区",
        "国籍": "中国",
        "ID": 5
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100884"
    },
    "t": {
      "identity": 100905,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-06-01",
        "ID": 6,
        "金额": 1200
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100905"
    }
  },
  {
    "c": {
      "identity": 100885,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "陈静",
        "地址": "成都市武侯区",
        "国籍": "中国",
        "ID": 6
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100885"
    },
    "t": {
      "identity": 100906,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-07-01",
        "ID": 7,
        "金额": 3000
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100906"
    }
  },
  {
    "c": {
      "identity": 100886,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "周杰",
        "地址": "武汉市江岸区",
        "国籍": "中国",
        "ID": 7
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100886"
    },
    "t": {
      "identity": 100907,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-08-01",
        "ID": 8,
        "金额": 600
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100907"
    }
  },
  {
    "c": {
      "identity": 100887,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "吴明",
        "地址": "南京市玄武区",
        "国籍": "中国",
        "ID": 8
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100887"
    },
    "t": {
      "identity": 100909,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-10-01",
        "ID": 10,
        "金额": 2500
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100909"
    }
  },
  {
    "c": {
      "identity": 100887,
      "labels": [
        "客户"
      ],
      "properties": {
        "姓名": "吴明",
        "地址": "南京市玄武区",
        "国籍": "中国",
        "ID": 8
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100887"
    },
    "t": {
      "identity": 100908,
      "labels": [
        "交易"
      ],
      "properties": {
        "时间戳": "2022-09-01",
        "ID": 9,
        "金额": 900
      },
      "elementId": "4:a9f31338-676c-49b8-9177-0c3d8ee69987:100908"
    }
  }
]
```

```cypher
展示客户节点、交易节点、客户节点和银行节点之间的关系 
MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->(b:客户), (c)-[:持有账户]->(bank:银行)
RETURN c, t, b, bank
```

```cypher
实体关系分析
通过构建客户、受益人、银行、交易等节点，并建立它们之间的关系，可以分析实体之间的交互模式和关联关系。例如，通过分析客户与受益人之间的交易关系，可以发现潜在的洗钱行为。如分析客户与受益人之间的关系，以发现潜在的洗钱行为。如反洗钱定义：交易数量大于2 或 交易金额总和大于等于3000 的行为。

MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->(b:客户)
WITH c, b, COUNT(t) AS transactionCount, sum(t.金额) as totalAmount
WHERE transactionCount > 2 or totalAmount >= 3000
RETURN c, b, transactionCount, totalAmount

╒════════════════════════════════════════════╤═════════════════════════════════════════════╤════════════════╤═══════════╕
│c                                           │b                                            │transactionCount│totalAmount│
╞════════════════════════════════════════════╪═════════════════════════════════════════════╪════════════════╪═══════════╡
│(:客户 {姓名: "陈静",地址: "成都市武侯区",国籍: "中国",ID: 6})│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1}) │1               │3000       │
├────────────────────────────────────────────┼─────────────────────────────────────────────┼────────────────┼───────────┤
│(:客户 {姓名: "吴明",地址: "南京市玄武区",国籍: "中国",ID: 8})│(:客户 {姓名: "李娜",地址: "上海市浦东新区",国籍: "中国",ID: 2})│2               │3400       │
├────────────────────────────────────────────┼─────────────────────────────────────────────┼────────────────┼───────────┤
│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1})│(:客户 {姓名: "赵敏",地址: "深圳市南山区",国籍: "中国",ID: 4}) │3               │3500       │
└────────────────────────────────────────────┴─────────────────────────────────────────────┴────────────────┴───────────┘
```

```cypher
交易异常检测
检测大额交易：金额超过 10000

MATCH (c:客户)-[:发起交易]->(t:交易)
WHERE t.金额 > 10000
RETURN c, t
```

```cypher
检测频繁的小额交易：金额1000，且超过10笔交易

MATCH (c:客户)-[:发起交易]->(t:交易)
WHERE t.金额 < 1000
WITH c, COUNT(t) AS transactionCount
WHERE transactionCount > 10
RETURN c, transactionCount
```

```cypher
关系网络分析
识别关键节点和关键关系，帮助发现洗钱网络。

查询拥有最多交易的3个客户及起转账笔数，总金额

MATCH (c:客户)-[:发起交易]->(t:交易)
WITH c, COUNT(t) AS transactionCount,sum(t.金额) as totalAmount
ORDER BY transactionCount DESC
LIMIT 3
RETURN c, transactionCount, totalAmount

╒════════════════════════════════════════════╤════════════════╤═══════════╕
│c                                           │transactionCount│totalAmount│
╞════════════════════════════════════════════╪════════════════╪═══════════╡
│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1})│3               │3500       │
├────────────────────────────────────────────┼────────────────┼───────────┤
│(:客户 {姓名: "赵敏",地址: "深圳市南山区",国籍: "中国",ID: 4})│2               │2300       │
├────────────────────────────────────────────┼────────────────┼───────────┤
│(:客户 {姓名: "吴明",地址: "南京市玄武区",国籍: "中国",ID: 8})│2               │3400       │
└────────────────────────────────────────────┴────────────────┴───────────┘
```

```cypher
查询频繁交易的客户与受益人

转账超过2次的客户与客户以及交易次数、交易金额

MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->(b:客户)
WITH c, b, COUNT(t) AS transactionCount,sum(t.金额) as totalAmount
WHERE transactionCount > 2
RETURN c, b, transactionCount,totalAmount

╒════════════════════════════════════════════╤════════════════════════════════════════════╤════════════════╤═══════════╕
│c                                           │b                                           │transactionCount│totalAmount│
╞════════════════════════════════════════════╪════════════════════════════════════════════╪════════════════╪═══════════╡
│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1})│(:客户 {姓名: "赵敏",地址: "深圳市南山区",国籍: "中国",ID: 4})│3               │3500       │
└────────────────────────────────────────────┴────────────────────────────────────────────┴────────────────┴───────────┘
```

根据您的需求，我们需要在Cypher查询中加入交易时间段的检测，以识别在特定时间段内交易频繁的客户。以下是修改后的Cypher查询，用于检测在一定时间段内交易次数超过预设阈值的客户：

```cypher
// 定义时间段的开始和结束日期
WITH date({year: 2022, month: 1, day: 1}) AS startDate, date({year: 2023, month: 12, day: 30}) AS endDate

// 匹配客户、交易和转账关系，并过滤出在指定时间段内的交易
MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->(n)
where date(t.`时间戳`) > startDate and date(t.`时间戳`) < endDate

// 统计每个客户在指定时间段内的交易次数
WITH c, COUNT(t) AS transferCount,t,n
WHERE transferCount > 2  // threshold 是预设的阈值

// 返回交易次数超过阈值的客户
RETURN c,t,n
;

// 定义时间段的开始和结束日期
WITH date({year: 2022, month: 1, day: 1}) AS startDate, date({year: 2023, month: 12, day: 30}) AS endDate

// 匹配客户、交易和转账关系，并过滤出在指定时间段内的交易
MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->()
where date(t.`时间戳`) > startDate and date(t.`时间戳`) < endDate

// 统计每个客户在指定时间段内的交易次数
WITH c, COUNT(t) AS transferCount
WHERE transferCount > 1  // threshold 是预设的阈值

return c,transferCount
```

在这个查询中，我们首先使用`WITH`子句定义了时间段的开始日期和结束日期。然后，我们使用`MATCH`语句匹配客户、交易和转账关系，并使用`WHERE`子句过滤出在指定时间段内的交易。接着，我们使用`WITH`子句统计每个客户在指定时间段内的交易次数，并使用`WHERE`子句过滤出交易次数超过预设阈值的客户。最后，我们返回这些客户的信息。

请注意，`{threshold}`需要您根据实际情况设置一个具体的数值。您可以根据业务需求和历史数据来确定这个阈值。此外，`date()`函数用于创建指定的日期对象，您可以根据需要调整日期参数。这个查询可以帮助您识别在特定时间段内交易频繁的客户，从而进一步分析和处理潜在的风险交易。


```shell
// 定义时间段的开始和结束日期
WITH date({year: 2022, month: 1, day: 1}) AS startDate, date({year: 2023, month: 12, day: 30}) AS endDate

// 匹配客户、任意长度的交易路径和转账关系，并过滤出在指定时间段内的交易
MATCH (c:客户)-[r:发起交易*1..]->(t:交易)-[:转账给]->()
WHERE date(t.时间戳) >= startDate AND date(t.时间戳) <= endDate

// 统计每个客户在指定时间段内的交易次数
WITH c, COUNT(t) AS transferCount
WHERE transferCount >= 1  // threshold 是预设的阈值

// 返回客户及其交易次数
RETURN c, transferCount

╒════════════════════════════════════════════╤═════════════╕
│c                                           │transferCount│
╞════════════════════════════════════════════╪═════════════╡
│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1})│3            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "赵敏",地址: "深圳市南山区",国籍: "中国",ID: 4})│2            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "刘洋",地址: "杭州市西湖区",国籍: "中国",ID: 5})│1            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "陈静",地址: "成都市武侯区",国籍: "中国",ID: 6})│1            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "周杰",地址: "武汉市江岸区",国籍: "中国",ID: 7})│1            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "吴明",地址: "南京市玄武区",国籍: "中国",ID: 8})│2            │
└────────────────────────────────────────────┴─────────────┘


// 定义时间段的开始和结束日期
WITH date({year: 2022, month: 1, day: 1}) AS startDate, date({year: 2023, month: 12, day: 30}) AS endDate

// 匹配客户、交易和转账关系，并过滤出在指定时间段内的交易
MATCH (c:客户)-[:发起交易]->(t:交易)-[:转账给]->()
where date(t.`时间戳`) > startDate and date(t.`时间戳`) < endDate

// 统计每个客户在指定时间段内的交易次数
WITH c, COUNT(t) AS transferCount
WHERE transferCount > 1  // threshold 是预设的阈值

return c,transferCount

╒════════════════════════════════════════════╤═════════════╕
│c                                           │transferCount│
╞════════════════════════════════════════════╪═════════════╡
│(:客户 {姓名: "张伟",地址: "北京市朝阳区",国籍: "中国",ID: 1})│2            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "赵敏",地址: "深圳市南山区",国籍: "中国",ID: 4})│2            │
├────────────────────────────────────────────┼─────────────┤
│(:客户 {姓名: "吴明",地址: "南京市玄武区",国籍: "中国",ID: 8})│2            │
└────────────────────────────────────────────┴─────────────┘
```

```shell
// 定义起始客户
WITH '张伟' AS startCustomer

// 匹配从startCustomer开始，经过一系列交易后返回到startCustomer的路径
MATCH path = (c1: 客户 {姓名: startCustomer})-[:发起交易]->(t1: 交易)-[:转账给]->(c2: 客户)-[:发起交易*1..]->(t2: 交易)-[:转账给]->(c1)

// 确保路径的起点和终点是同一个客户节点
WHERE 
// c1 = c1 AND 
length(path) > 2  // 确保路径长度大于2，即至少经过一次交易

// 提取路径和路径长度
RETURN path, length(path) AS pathLength;

// 定义起始客户
WITH '张伟' AS startCustomer

// 匹配从startCustomer开始，经过一系列交易后返回到startCustomer的路径
MATCH path = (c1: 客户 {姓名: startCustomer})-[:发起交易]->(t1: 交易)-[:转账给]->(c2: 客户)
-[:发起交易*0..]->(t2: 交易)-[:转账给*0..]->(c1)

// 确保路径的起点和终点是同一个客户节点，并且路径长度大于2
WHERE c1 = c1 AND length(path) > 2  // 确保路径长度大于2，即至少经过一次交易

// 提取路径和路径长度
RETURN path, length(path) AS pathLength;



CREATE (zhangwei: 客户 {姓名: '麻A'})
CREATE (zhao_min: 客户 {姓名: '麻B'})
CREATE (li_hua: 客户 {姓名: '麻C'})

CREATE (t1: 交易 {id: 'T1'})
CREATE (t2: 交易 {id: 'T2'})
CREATE (t3: 交易 {id: 'T3'})
CREATE (t4: 交易 {id: 'T4'})
CREATE (t5: 交易 {id: 'T5'})

CREATE (zhangwei)-[:发起交易]->(t1)
CREATE (t1)-[:转账给]->(zhao_min)

CREATE (zhao_min)-[:发起交易]->(t2)
CREATE (t2)-[:转账给]->(li_hua)

CREATE (li_hua)-[:发起交易]->(t3)
CREATE (t3)-[:转账给]->(zhangwei)

CREATE (zhangwei)-[:发起交易]->(t4)
CREATE (t4)-[:转账给]->(zhao_min)

CREATE (zhao_min)-[:发起交易]->(t5)
CREATE (t5)-[:转账给]->(zhangwei);

// 该语句不可行（中间的条件导致后面无法查询到合适的数据）（Depracated)
// 定义起始客户
WITH '麻A' AS startCustomer

// 匹配从startCustomer开始，经过一系列交易后返回到startCustomer的路径
MATCH path = (c1: 客户 {姓名: startCustomer})-[:发起交易]->(t1: 交易)-[:转账给]->(c2: 客户)-[:发起交易*0..]->(t2: 交易)-[:转账给*0..]->(c1)

// 确保路径的起点和终点是同一个客户节点，并且路径长度大于2
WHERE c1 = c1 AND length(path) > 2  // 确保路径长度大于2，即至少经过一次交易

// 提取路径和路径长度
RETURN path, length(path) AS pathLength;

// 重新构造数据
CREATE (lua: 客户 {姓名: '陆A'})
CREATE (lub: 客户 {姓名: '陆B'})
CREATE (luc: 客户 {姓名: '陆C'})
CREATE (lud: 客户 {姓名: '陆D'})
CREATE (lue: 客户 {姓名: '陆E'})

CREATE (t1: 交易 {id: '陆T1'})
CREATE (t2: 交易 {id: '陆T2'})
CREATE (t3: 交易 {id: '陆T3'})
CREATE (t4: 交易 {id: '陆T4'})
CREATE (t5: 交易 {id: '陆T5'})

CREATE (lua)-[:发起交易]->(t1)
CREATE (t1)-[:转账给]->(lub)

CREATE (lub)-[:发起交易]->(t2)
CREATE (t2)-[:转账给]->(luc)

CREATE (luc)-[:发起交易]->(t3)
CREATE (t3)-[:转账给]->(lud)

CREATE (lud)-[:发起交易]->(t4)
CREATE (t4)-[:转账给]->(lue)

CREATE (lue)-[:发起交易]->(t5)
CREATE (t5)-[:转账给]->(lua);

// 该语句可行（先构造合适的匹配条件）
// 定义起始客户
WITH '陆A' AS startCustomer match p=((c1:客户 {姓名: startCustomer})
-[t:发起交易|转账给*1..]->(c1)) return p;

// 定义起始客户
WITH '陆A' AS startCustomer

// 该语句有Bug，其中的AND all(node IN nodes(p) WHERE single(n IN nodes(p) WHERE n = node))  // 确保路径中的所有节点都是唯一的 导致开始节点与最后的一个节点的重复条件冲突，导致数据匹配被断言了（后续改进是要不去掉，要不就将最后的节点去掉，见后面的语句）
// 使用可变长度的关系匹配来找到闭环路径
MATCH p=(c1:客户 {姓名: startCustomer})
-[:发起交易|转账给*1..]->(c1)  // 使用可变长度的关系匹配，确保至少有一个关系
WHERE ALL(r IN relationships(p) WHERE type(r) IN ['发起交易', '转账给'])  // 确保所有的关系都是发起交易或转账给
AND ALL(n IN nodes(p) WHERE n:客户 OR n:交易)  // 确保路径中的所有节点都是客户或交易
AND length(p) > 2  // 确保路径长度大于2，即至少经过一次交易
AND all(node IN nodes(p) WHERE single(n IN nodes(p) WHERE n = node))  // 确保路径中的所有节点都是唯一的
return p;

// 这里面使用了tail(nodes(p)) 将最后的节点剔除掉，避免因为这个问题导致match被断言而匹配不到合适的数据
// 定义起始客户
WITH '陆A' AS startCustomer
// 使用可变长度的关系匹配来找到闭环路径
MATCH p=(c1:客户 {姓名: startCustomer})
-[:发起交易|转账给*1..]->(c1)  // 使用可变长度的关系匹配，确保至少有一个关系
WHERE ALL(r IN relationships(p) WHERE type(r) IN ['发起交易', '转账给'])  // 确保所有的关系都是发起交易或转账给
AND ALL(n IN nodes(p) WHERE n:客户 OR n:交易)  // 确保路径中的所有节点都是客户或交易
AND length(p) > 2  // 确保路径长度大于2，即至少经过一次交易
AND all(node IN tail(nodes(p)) WHERE single(n IN tail(nodes(p)) WHERE n = node))  // 确保除了首尾节点外的所有节点都是唯一的

// 提取路径及其相关信息
RETURN p AS path,
       [node IN nodes(p) | node.姓名] AS customerNames,
       [rel IN relationships(p) WHERE type(rel)='发起交易' | rel.id] AS transactionIds,  // 只获取发起交易的关系ID
       length(p) AS pathLength

╒══════════════════════════════════════════════════════════════════════╤══════════════════════════════════════════╤══════════════════╤══════════╕
│path                                                                  │customerNames                             │transactionIds    │pathLength│
╞══════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════╪══════════════════╪══════════╡
│(:客户 {姓名: "麻A"})-[:发起交易]->(:交易 {id: "T1"})-[:转账给]->(:客户 {姓名: "麻B"})-[:│["麻A", null, "麻B", null, "麻A"]            │[null, null]      │4         │
│发起交易]->(:交易 {id: "T5"})-[:转账给]->(:客户 {姓名: "麻A"})                      │                                          │                  │          │
├──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────┼──────────┤
│(:客户 {姓名: "麻A"})-[:发起交易]->(:交易 {id: "T1"})-[:转账给]->(:客户 {姓名: "麻B"})-[:│["麻A", null, "麻B", null, "麻C", null, "麻A"]│[null, null, null]│6         │
│发起交易]->(:交易 {id: "T2"})-[:转账给]->(:客户 {姓名: "麻C"})-[:发起交易]->(:交易 {id: "T│                                          │                  │          │
│3"})-[:转账给]->(:客户 {姓名: "麻A"})                                         │                                          │                  │          │
├──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────┼──────────┤
│(:客户 {姓名: "麻A"})-[:发起交易]->(:交易 {id: "T4"})-[:转账给]->(:客户 {姓名: "麻B"})-[:│["麻A", null, "麻B", null, "麻A"]            │[null, null]      │4         │
│发起交易]->(:交易 {id: "T5"})-[:转账给]->(:客户 {姓名: "麻A"})                      │                                          │                  │          │
├──────────────────────────────────────────────────────────────────────┼──────────────────────────────────────────┼──────────────────┼──────────┤
│(:客户 {姓名: "麻A"})-[:发起交易]->(:交易 {id: "T4"})-[:转账给]->(:客户 {姓名: "麻B"})-[:│["麻A", null, "麻B", null, "麻C", null, "麻A"]│[null, null, null]│6         │
│发起交易]->(:交易 {id: "T2"})-[:转账给]->(:客户 {姓名: "麻C"})-[:发起交易]->(:交易 {id: "T│                                          │                  │          │
│3"})-[:转账给]->(:客户 {姓名: "麻A"})                                         │                                          │                  │          │
└──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────┴──────────────────┴───────

╒══════════════════════════════════════════════════════════════════════╤══════════════════════════════════════════════════════════════════╤══════════════════════════════╤══════════╕
│path                                                                  │customerNames                                                     │transactionIds                │pathLength│
╞══════════════════════════════════════════════════════════════════════╪══════════════════════════════════════════════════════════════════╪══════════════════════════════╪══════════╡
│(:客户 {姓名: "陆A"})-[:发起交易]->(:交易 {id: "陆T1"})-[:转账给]->(:客户 {姓名: "陆B"})-[│["陆A", null, "陆B", null, "陆C", null, "陆D", null, "陆E", null, "陆A"]│[null, null, null, null, null]│10        │
│:发起交易]->(:交易 {id: "陆T2"})-[:转账给]->(:客户 {姓名: "陆C"})-[:发起交易]->(:交易 {id: │                                                                  │                              │          │
│"陆T3"})-[:转账给]->(:客户 {姓名: "陆D"})-[:发起交易]->(:交易 {id: "陆T4"})-[:转账给]->(:│                                                                  │                              │          │
│客户 {姓名: "陆E"})-[:发起交易]->(:交易 {id: "陆T5"})-[:转账给]->(:客户 {姓名: "陆A"})    │                                                                  │                              │          │
└──────────────────────────────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────┴──


```

![x19](static/img/corp/graph-19.svg)

![x19](static/img/corp/graph-20.svg)

您提出的修改是正确的。为了确保路径中的所有节点（除了首尾节点）都是唯一的，我们需要在`single`函数中也使用`tail(nodes(p))`来排除首尾节点的重复。这样可以保证路径中间部分的所有节点都是唯一的，同时允许首尾节点相同。

下面是修正后的Cypher查询：

```cypher
// 定义起始客户
WITH '陆A' AS startCustomer

// 使用可变长度的关系匹配来找到闭环路径
MATCH p=(c1:客户 {姓名: startCustomer})
-[:发起交易|转账给*1..]->(c1)  // 使用可变长度的关系匹配，确保至少有一个关系
WHERE ALL(r IN relationships(p) WHERE type(r) IN ['发起交易', '转账给'])  // 确保所有的关系都是发起交易或转账给
AND ALL(n IN nodes(p) WHERE n:客户 OR n:交易)  // 确保路径中的所有节点都是客户或交易
AND length(p) > 2  // 确保路径长度大于2，即至少经过一次交易
AND all(node IN tail(nodes(p)) WHERE single(n IN tail(nodes(p)) WHERE n = node))  // 确保除了首尾节点外的所有节点都是唯一的

// 提取路径及其相关信息
RETURN p AS path,
       [node IN nodes(p) | node.姓名] AS customerNames,
       [rel IN relationships(p) | rel.id] AS transactionIds,  // 获取所有关系ID
       length(p) AS pathLength
```

### 解释关键点

- **`tail(nodes(p))`**：这个函数用于移除路径节点列表中的第一个元素，从而使得我们在检查唯一性时排除了路径的第一个节点（同时也是最后一个节点）。这样可以允许路径形成一个闭环。
- **`all(node IN tail(nodes(p)) WHERE single(n IN tail(nodes(p)) WHERE n = node))`**：这一条件确保了除了首尾节点外的所有节点都是唯一的，防止出现循环路径。

### 查询逻辑解释

1. **定义变量**：
   - `WITH '陆A' AS startCustomer`：定义起始客户为“陆A”。

2. **匹配路径**：
   - `MATCH p=(c1:客户 {姓名: startCustomer})-[:发起交易|转账给*1..]->(c1)`：匹配从起始客户开始的一系列交易和转账关系，直到回到起始客户。这里的`*1..`表示至少要有一条关系，确保路径不是空的。

3. **过滤条件**：
   - `WHERE ALL(r IN relationships(p) WHERE type(r) IN ['发起交易', '转账给'])`：确保路径中的所有关系类型都是`发起交易`或`转账给`。
   - `AND ALL(n IN nodes(p) WHERE n:客户 OR n:交易)`：确保路径中的所有节点都是`客户`或`交易`类型的。
   - `AND length(p) > 2`：确保路径长度大于2，即至少经过一次交易。
   - `AND all(node IN tail(nodes(p)) WHERE single(n IN tail(nodes(p)) WHERE n = node))`：确保除了首尾节点外的所有节点都是唯一的，防止出现循环路径。

4. **返回结果**：
   - `RETURN p AS path, [node IN nodes(p) | node.姓名] AS customerNames, [rel IN relationships(p) | rel.id] AS transactionIds, length(p) AS pathLength`：返回完整的路径、路径中所有客户的姓名、所有关系ID以及路径的长度。

这个查询现在应该能够正确地找到从“陆A”开始并通过一系列交易最终返回到“陆A”的所有闭环路径，并提供每个路径的相关信息。请根据您的实际数据模型进行测试和调整。如果有进一步的问题或需要额外的帮助，请随时告诉我。
        </pre></code>
    </div>
</div>
</body>
</html>